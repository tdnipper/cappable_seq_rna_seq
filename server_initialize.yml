- name: Install Miniconda3 and create Conda environment
  hosts: labserver # Host to run the playbook on
  # remote_user: ubuntu # User to
  become: yes # Run tasks as root
  # vars:
  #   ansible_private_key_file: "~/keys/ssh-key-2024-04-08.key"


  tasks:
  # - name: Ping the remote server
  #   ansible.builtin.ping:
  
  - name: Create directory for Miniconda3 installation
    ansible.builtin.file:
      path: "/home/ubuntu/tmp"
      state: directory

  - name: Download Miniconda3 installer
    ansible.builtin.get_url:
      url: "https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh"
      dest: "/home/ubuntu/tmp/Miniconda3-latest-Linux-aarch64.sh"
      mode: 0755

  - name: Install Miniconda3
    command: "/home/ubuntu/tmp/Miniconda3-latest-Linux-aarch64.sh -b -p /home/ubuntu/miniconda3"
    args:
      creates: "/home/ubuntu/miniconda3"
  
  - name: Cleanup Miniconda3 installer
    command: "rm -rf /home/ubuntu/tmp/Miniconda3-latest-Linux-aarch64.sh"
    args:
      removes: "/home/ubuntu/tmp/Miniconda3-latest-Linux-aarch64.sh"

  - name: Initialize Conda
    command: "/home/ubuntu/miniconda3/bin/conda init bash"
    args:
      creates: "/home/ubuntu/.bashrc"

  - name: Copy Conda environment file to remote server
    ansible.builtin.copy:
      src: "clipseq.yml"
      dest: "/home/ubuntu/clipseq.yml"

  - name: Create Conda environment from environment.yml
    command: "~/miniconda3/bin/conda env create -f clipseq.yml"

